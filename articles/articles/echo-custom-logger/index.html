<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Custome Logger using LoggerWithConfig in Echo - /home/lunarxlark/.config/blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:description" content><meta name=twitter:description content><meta name=description content><meta name=description content><meta property="og:title" content="Custome Logger using LoggerWithConfig in Echo | /home/lunarxlark/.config/blog"><meta name=twitter:title content="Custome Logger using LoggerWithConfig in Echo | /home/lunarxlark/.config/blog"><meta property="og:image" content><meta itemprop=name content="Custome Logger using LoggerWithConfig in Echo | /home/lunarxlark/.config/blog"><meta name=application-name content="Custome Logger using LoggerWithConfig in Echo | /home/lunarxlark/.config/blog"><meta property="og:site_name" content><meta property="og:title" content="Custome Logger using LoggerWithConfig in Echo"><meta property="og:description" content="WebFramework EchoのLoggerを弄っていて気付いた点があったのでメモ。
sample code
箇条書き  responseログにHeader X-Any-Headerを出力したい場合、ログフォーマットに&#34;any_header&#34;:${header:x-any-header}を指定すればいいよ responseログにQueryParamerter ?anyparam=xxxを出力したい場合、ログフォーマットに&#34;any_query&#34;:${query:anyparam}を指定すればいいよ デフォルトで出力されるカラム&rsquo;id&rsquo;はHeader X-Request-Id を指定すると出力されるよ Skipperを設定することで、path毎にログ出力する/しない等を設定出来るよ  1, 2, 3はEchoのそういう機能だってことで特にありません。 4は結構便利だなと思いました。以下のサンプルコードでは、/healthcheckに来た場合とCI/CD等での自動テスト時にはresponseログを出力しないようにする設定例です。
sample // Middleware e.Use(middleware.LoggerWithConfig(customLogger())) // Handler e.GET(&#34;/greet&#34;, greet) e.GET(&#34;/healthcheck&#34;, healthcheck) var ResponseLogForamt = `{` + `&#34;time&#34;:&#34;${time_custom}&#34;,` + `&#34;id&#34;:&#34;${id}&#34;,` + `&#34;remote_ip&#34;:&#34;${remote_ip}&#34;,` + `&#34;host&#34;:&#34;${host}&#34;,` + `&#34;method&#34;:&#34;${method}&#34;,` + `&#34;uri&#34;:&#34;${uri}&#34;,` + `&#34;user_agent&#34;:&#34;${user_agent}&#34;,` + `&#34;status&#34;:${status},` + `&#34;error&#34;:&#34;${error}&#34;,` + `&#34;latency&#34;:${latency},` + `&#34;latency_human&#34;:&#34;${latency_human}&#34;,` + `&#34;bytes_in&#34;:${bytes_in},` + `&#34;bytes_out&#34;:${bytes_out},` + `&#34;forwarded-for&#34;:&#34;${header:x-forwarded-for}&#34;,` + `&#34;same-as-id&#34;:${header:X-Request-Id},` + `&#34;query&#34;:${query:lang}` + `}` func customLogger() middleware.LoggerConfig { cl := middleware."><meta property="og:type" content="article"><meta property="og:url" content="https://lunarxlark.github.io/articles/articles/echo-custom-logger/"><meta property="article:published_time" content="2020-11-10T02:51:09+09:00"><meta property="article:modified_time" content="2020-11-10T02:51:09+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Custome Logger using LoggerWithConfig in Echo"><meta name=twitter:description content="WebFramework EchoのLoggerを弄っていて気付いた点があったのでメモ。
sample code
箇条書き  responseログにHeader X-Any-Headerを出力したい場合、ログフォーマットに&#34;any_header&#34;:${header:x-any-header}を指定すればいいよ responseログにQueryParamerter ?anyparam=xxxを出力したい場合、ログフォーマットに&#34;any_query&#34;:${query:anyparam}を指定すればいいよ デフォルトで出力されるカラム&rsquo;id&rsquo;はHeader X-Request-Id を指定すると出力されるよ Skipperを設定することで、path毎にログ出力する/しない等を設定出来るよ  1, 2, 3はEchoのそういう機能だってことで特にありません。 4は結構便利だなと思いました。以下のサンプルコードでは、/healthcheckに来た場合とCI/CD等での自動テスト時にはresponseログを出力しないようにする設定例です。
sample // Middleware e.Use(middleware.LoggerWithConfig(customLogger())) // Handler e.GET(&#34;/greet&#34;, greet) e.GET(&#34;/healthcheck&#34;, healthcheck) var ResponseLogForamt = `{` + `&#34;time&#34;:&#34;${time_custom}&#34;,` + `&#34;id&#34;:&#34;${id}&#34;,` + `&#34;remote_ip&#34;:&#34;${remote_ip}&#34;,` + `&#34;host&#34;:&#34;${host}&#34;,` + `&#34;method&#34;:&#34;${method}&#34;,` + `&#34;uri&#34;:&#34;${uri}&#34;,` + `&#34;user_agent&#34;:&#34;${user_agent}&#34;,` + `&#34;status&#34;:${status},` + `&#34;error&#34;:&#34;${error}&#34;,` + `&#34;latency&#34;:${latency},` + `&#34;latency_human&#34;:&#34;${latency_human}&#34;,` + `&#34;bytes_in&#34;:${bytes_in},` + `&#34;bytes_out&#34;:${bytes_out},` + `&#34;forwarded-for&#34;:&#34;${header:x-forwarded-for}&#34;,` + `&#34;same-as-id&#34;:${header:X-Request-Id},` + `&#34;query&#34;:${query:lang}` + `}` func customLogger() middleware.LoggerConfig { cl := middleware."><script src=https://lunarxlark.github.io/js/feather.min.js></script><link href=https://lunarxlark.github.io/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://lunarxlark.github.io/css/main.css><link rel=stylesheet type=text/css href=https://lunarxlark.github.io/css/dark.css></head><body><div class=content><header><div class=main><a href=https://lunarxlark.github.io/>/home/lunarxlark/.config/blog</a></div><nav><a href=/>Home</a>
<a href=/about>About</a>
<a href=/articles>Articles</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Custome Logger using LoggerWithConfig in Echo</h1><div class=meta>Posted on Nov 10, 2020</div></div><section class=body><p>WebFramework <code>Echo</code>のLoggerを弄っていて気付いた点があったのでメモ。</p><p><a href=https://github.com/lunarxlark/sample-echo>sample code</a></p><h2 id=箇条書き>箇条書き</h2><ol><li>responseログにHeader <code>X-Any-Header</code>を出力したい場合、ログフォーマットに<code>"any_header":${header:x-any-header}</code>を指定すればいいよ</li><li>responseログにQueryParamerter <code>?anyparam=xxx</code>を出力したい場合、ログフォーマットに<code>"any_query":${query:anyparam}</code>を指定すればいいよ</li><li>デフォルトで出力されるカラム&rsquo;id&rsquo;はHeader <code>X-Request-Id</code> を指定すると出力されるよ</li><li>Skipperを設定することで、path毎にログ出力する/しない等を設定出来るよ</li></ol><p>1, 2, 3はEchoのそういう機能だってことで特にありません。
4は結構便利だなと思いました。以下のサンプルコードでは、/healthcheckに来た場合とCI/CD等での自動テスト時にはresponseログを出力しないようにする設定例です。</p><h2 id=sample>sample</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Middleware
</span><span style=color:#75715e></span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>LoggerWithConfig</span>(<span style=color:#a6e22e>customLogger</span>()))

<span style=color:#75715e>// Handler
</span><span style=color:#75715e></span><span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/greet&#34;</span>, <span style=color:#a6e22e>greet</span>)
<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/healthcheck&#34;</span>, <span style=color:#a6e22e>healthcheck</span>)

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ResponseLogForamt</span> = <span style=color:#e6db74>`{`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;time&#34;:&#34;${time_custom}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;id&#34;:&#34;${id}&#34;,`</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>`&#34;remote_ip&#34;:&#34;${remote_ip}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;host&#34;:&#34;${host}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;method&#34;:&#34;${method}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;uri&#34;:&#34;${uri}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;user_agent&#34;:&#34;${user_agent}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;status&#34;:${status},`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;error&#34;:&#34;${error}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;latency&#34;:${latency},`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;latency_human&#34;:&#34;${latency_human}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;bytes_in&#34;:${bytes_in},`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;bytes_out&#34;:${bytes_out},`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;forwarded-for&#34;:&#34;${header:x-forwarded-for}&#34;,`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;same-as-id&#34;:${header:X-Request-Id},`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`&#34;query&#34;:${query:lang}`</span> <span style=color:#f92672>+</span>
	<span style=color:#e6db74>`}`</span>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>customLogger</span>() <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>LoggerConfig</span> {
	<span style=color:#a6e22e>cl</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>DefaultLoggerConfig</span>
	<span style=color:#a6e22e>cl</span>.<span style=color:#a6e22e>Skipper</span> = <span style=color:#a6e22e>customeSkipper</span>
	<span style=color:#a6e22e>cl</span>.<span style=color:#a6e22e>Format</span> = <span style=color:#a6e22e>ResponseLogForamt</span>
	<span style=color:#a6e22e>cl</span>.<span style=color:#a6e22e>CustomTimeFormat</span> = <span style=color:#e6db74>&#34;2006/01/02 15:04:05.00000&#34;</span>

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cl</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>customeSkipper</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Path</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;/healthcheck&#34;</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;ENV&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;auto-test&#34;</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
	}
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>greet</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>QueryParam</span>(<span style=color:#e6db74>&#34;lang&#34;</span>) {
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;jp&#34;</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#e6db74>&#34;こんにちは\n&#34;</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;en&#34;</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#e6db74>&#34;Hello World\n&#34;</span>)
	<span style=color:#66d9ef>default</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#e6db74>&#34;ウホホイ!!\n&#34;</span>)
	}
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>healthcheck</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>echo</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#e6db74>&#34;I&#39;m fine\n&#34;</span>)
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-- request
$ curl <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -X GET <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Forwarded-For: achoo&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-Request-Id: requestid123&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#e6db74>&#34;http://localhost/greet?lang=en&#34;</span>

-- response log
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;time&#34;</span>:<span style=color:#e6db74>&#34;2020/11/10 00:17:09.28534&#34;</span>,
  <span style=color:#e6db74>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;requestid123&#34;</span>,
  <span style=color:#e6db74>&#34;remote_ip&#34;</span>:<span style=color:#e6db74>&#34;achoo&#34;</span>,
  <span style=color:#e6db74>&#34;host&#34;</span>:<span style=color:#e6db74>&#34;localhost&#34;</span>,
  <span style=color:#e6db74>&#34;method&#34;</span>:<span style=color:#e6db74>&#34;GET&#34;</span>,
  <span style=color:#e6db74>&#34;uri&#34;</span>:<span style=color:#e6db74>&#34;/greet?lang=en&#34;</span>,
  <span style=color:#e6db74>&#34;user_agent&#34;</span>:<span style=color:#e6db74>&#34;curl/7.64.1&#34;</span>,
  <span style=color:#e6db74>&#34;status&#34;</span>:200,
  <span style=color:#e6db74>&#34;error&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,
  <span style=color:#e6db74>&#34;latency&#34;</span>:18699,
  <span style=color:#e6db74>&#34;latency_human&#34;</span>:<span style=color:#e6db74>&#34;18.699µs&#34;</span>,
  <span style=color:#e6db74>&#34;bytes_in&#34;</span>:0,
  <span style=color:#e6db74>&#34;bytes_out&#34;</span>:12,
  <span style=color:#e6db74>&#34;forwarded-for&#34;</span>:<span style=color:#e6db74>&#34;achoo&#34;</span>,
  <span style=color:#e6db74>&#34;same-as-id&#34;</span>:requestid123,
  <span style=color:#e6db74>&#34;query&#34;</span>:en
<span style=color:#f92672>}</span>
</code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/go>go</a></li><li><a href=/tags/echo>echo</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/lunarxlark/ title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/lunarxlark/ title=Twitter><i data-feather=twitter></i></a>|<a class=soc href=https://instagram.com/lunarxlark/ title=Instagram><i data-feather=instagram></i></a>|⚡️
2021 © lunarxlark | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-HLW147X7ET','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></div></body></html>