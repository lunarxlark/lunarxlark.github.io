<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>aws-cliで始めるCloudFormation - /home/lunarxlark/.config/blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:description" content><meta name=twitter:description content><meta name=description content><meta name=description content><meta property="og:title" content="aws-cliで始めるCloudFormation | /home/lunarxlark/.config/blog"><meta name=twitter:title content="aws-cliで始めるCloudFormation | /home/lunarxlark/.config/blog"><meta property="og:image" content><meta itemprop=name content="aws-cliで始めるCloudFormation | /home/lunarxlark/.config/blog"><meta name=application-name content="aws-cliで始めるCloudFormation | /home/lunarxlark/.config/blog"><meta property="og:site_name" content><meta property="og:title" content="aws-cliで始めるCloudFormation"><meta property="og:description" content="目的

CloudFormationで使われる用語を理解する
CloudFormationの構成を理解する
出来るだけaws-cliのコマンドを実行していく"><meta property="og:type" content="article"><meta property="og:url" content="https://lunarxlark.github.io/post/aws/getting-start-cloudformation/"><meta property="article:published_time" content="2019-03-05T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="aws-cliで始めるCloudFormation"><meta name=twitter:description content="目的

CloudFormationで使われる用語を理解する
CloudFormationの構成を理解する
出来るだけaws-cliのコマンドを実行していく"><script src=https://lunarxlark.github.io/js/feather.min.js></script><link href=https://lunarxlark.github.io/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://lunarxlark.github.io/css/main.css><link rel=stylesheet type=text/css href=https://lunarxlark.github.io/css/dark.css></head><body><div class=content><header><div class=main><a href=https://lunarxlark.github.io/>/home/lunarxlark/.config/blog</a></div><nav><a href=/>Home</a>
<a href=/about>About</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>aws-cliで始めるCloudFormation</h1><div class=meta>Posted on Mar 5, 2019</div></div><section class=body><h4 id=目的>目的</h4><ul><li>CloudFormationで使われる用語を理解する</li><li>CloudFormationの構成を理解する</li><li>出来るだけaws-cliのコマンドを実行していく</li></ul><h4 id=前提条件>前提条件</h4><ul><li>aws-cliがインストール済み</li><li>AWSのaccess key発行済</li><li>access keyを環境変数に設定済み</li><li>CFn実行にS3にテンプレートが保存される動作は割愛する</li><li>stack-nameが違っていても気にしない。ブログ記述時の試行錯誤によるもの。</li></ul><h4 id=テンプレート>テンプレート</h4><p>CloudFormation(以後、CFn)では、リソースを記述するファイルを<code>CFnテンプレート</code>を呼ぶ。<br>CFnテンプレートの記法は、<code>JSON</code> or <code>YAML</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:example.yaml data-lang=yaml:example.yaml><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>2010-09-09</span>
<span style=color:#f92672>Description</span>: <span style=color:#ae81ff>Create coco&#39;s vpc</span>
<span style=color:#f92672>Resources</span>:
  <span style=color:#f92672>CocoFirstVPC</span>:
    <span style=color:#f92672>Type</span>: <span style=color:#e6db74>&#39;AWS::EC2::VPC&#39;</span>
    <span style=color:#f92672>Properties</span>: 
      <span style=color:#f92672>CidrBlock</span>: <span style=color:#ae81ff>10.10.0.0</span><span style=color:#ae81ff>/16</span>
</code></pre></div><h4 id=スタック>スタック</h4><p>関連リソースを管理するための単一ユニットを<code>スタック</code>という。<br>スタックを作成、更新、削除することでリソースのコレクションを作成、更新、削除する。
スタック内の全てのリソースはCFnテンプレートで定義される。
スタック作成時にパラメータを指定することで、インスタンスタイプなどをスタック作成時に指定できる。</p><p>ひとまず、ここまでで一度CFnをaws-cliから実行してみる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># stack作成</span>
<span style=color:#f92672>(</span>*<span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;&lt;&lt;</span> aws cloudformation create-stack --stack-name coco-vpc --template-body file://./example.yaml
<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;StackId&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:cloudformation:ap-northeast-1:012345678901:stack/coco-vpc/4a6f6260-3f09-11e9-a59f-066cec78e1f8&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># stack削除</span>
<span style=color:#f92672>(</span>*<span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;&lt;&lt;</span> aws cloudformation delete-stack --stack-name coco-vpc
</code></pre></div><p>CFnテンプレートから簡単なスタック作成/削除ができた。</p><h4 id=変更セット>変更セット</h4><p>スタックで実行中のリソースに変更を加える場合、スタックを更新する。
リソースに変更を加える前に変更案の概要となるのが<code>changeset(変更セット)</code>。</p><p>ここでは、前述で作成したVPCに対して、<code>tag:Name</code>としてcoco-vpcを与える。</p><p>CFnテンプレートにtagを追加する記述を追加</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>2010-09-09</span>
<span style=color:#f92672>Description</span>: <span style=color:#ae81ff>Create coco&#39;s vpc</span>
<span style=color:#f92672>Resources</span>:
  <span style=color:#f92672>CocoFirstVPC</span>:
    <span style=color:#f92672>Type</span>: <span style=color:#e6db74>&#39;AWS::EC2::VPC&#39;</span>
    <span style=color:#f92672>Properties</span>: 
      <span style=color:#f92672>CidrBlock</span>: <span style=color:#ae81ff>10.10.0.0</span><span style=color:#ae81ff>/16</span>
<span style=color:#75715e># START changeset target</span>
      <span style=color:#f92672>Tags</span>:
        -
          <span style=color:#f92672>Key</span>: <span style=color:#ae81ff>Name</span>
          <span style=color:#f92672>Value</span>: <span style=color:#ae81ff>coco-vpc</span>
<span style=color:#75715e># END changeset target</span>
</code></pre></div><p>変更したCFnテンプレートを用いて、changesetを作成。その後、changesetの確認と適用を行う。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># changeset作成</span>
<span style=color:#f92672>(</span>*<span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;&lt;&lt;</span> aws cloudformation create-change-set --stack-name coco-vpc --change-set-name first-changeset --template-body file://./example.yaml
<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;Id&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:cloudformation:ap-northeast-1:012345678901:changeSet/first-changeset/8c6d9520-df98-4fae-b00c-28c0267703fc&#34;</span>,
    <span style=color:#e6db74>&#34;StackId&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:cloudformation:ap-northeast-1:012345678901:stack/coco-vpc/4a6f6260-3f09-11e9-a59f-066cec78e1f8&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># changeset適用</span>
<span style=color:#f92672>(</span>*<span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;&lt;&lt;</span> aws cloudformation execute-change-set --stack-name coco-vpc --change-set-name first-changeset
</code></pre></div><p>以上が、CFnの用語説明とaws-cliからのstack操作/changeset操作の基本的な使い方になる。</p><h3 id=まとめ>まとめ</h3><p>Terraformとの比較</p><table><thead><tr><th>CloudFormation</th><th>Terraform</th></tr></thead><tbody><tr><td>CFnテンプレート</td><td>tfファイル</td></tr><tr><td>stack</td><td>module(?)</td></tr><tr><td>parameter</td><td>var</td></tr><tr><td>changeset作成</td><td>terraform plan &ndash;out のfile</td></tr><tr><td>changeset適用</td><td>terraform apply</td></tr></tbody></table></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/aws>AWS</a></li><li><a href=/tags/aws-cli>aws-cli</a></li><li><a href=/tags/cloudformation>CloudFormation</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/lunarxlark/ title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/lunarxlark/ title=Twitter><i data-feather=twitter></i></a>|<a class=soc href=https://instagram.com/lunarxlark/ title=Instagram><i data-feather=instagram></i></a>|⚡️
2020 © lunarxlark | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-135352101-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></div></body></html>