<!doctype html><html lang=ja dir=auto><head><meta name=generator content="Hugo 0.117.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>/home/lunarxlark/.config/blog</title><meta name=description content><meta name=author content><link rel=canonical href=https://lunarxlark.github.io/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><link rel=icon href=https://lunarxlark.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://lunarxlark.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://lunarxlark.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://lunarxlark.github.io/apple-touch-icon.png><link rel=mask-icon href=https://lunarxlark.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://lunarxlark.github.io/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-HC9218ZECN"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-HC9218ZECN",{anonymize_ip:!1})}</script><meta property="og:title" content="/home/lunarxlark/.config/blog"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://lunarxlark.github.io/"><meta property="og:site_name" content="/home/lunarxlark/.config/blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="/home/lunarxlark/.config/blog"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"/home/lunarxlark/.config/blog","url":"https://lunarxlark.github.io/","description":"","thumbnailUrl":"https://lunarxlark.github.io/favicon.ico","sameAs":["https://github.com/lunarxlark","https://twitter.com/lunarxlark"]}</script></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lunarxlark.github.io/ accesskey=h title="/home/lunarxlark/.config/blog (Alt + H)">/home/lunarxlark/.config/blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lunarxlark.github.io/ title=Home><span class=active>Home</span></a></li><li><a href=https://lunarxlark.github.io/about title=About><span>About</span></a></li><li><a href=https://lunarxlark.github.io/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class="first-entry home-info"><header class=entry-header><h1>Hi, I&rsquo;m lunarxlark</h1></header><div class=entry-content>I ❤ ⌨. crkbd user.</div><footer class=entry-footer><div class=social-icons><a href=https://github.com/lunarxlark target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/lunarxlark target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div></footer></article><article class=post-entry><header class=entry-header><h2>Raspberry Pi 4 Model B でKubernetes cluster構築した</h2></header><div class=entry-content><p>完成形です。いぇい。 材料 材料 個数 Raspberry Pi 4 Model B 8GB 4 PoE HAT(E) 4 PoE対応 スイッチングハブ 1 無線ルーター 1 MicroSD 128GB 4 LAN (0.15m) 4 LAN (0.3m) 1 ケース 1 追加スペーサー 50個入り 組み立ての感想 見た目をスッキリさせたかったので、ラズパイの電源は PoE HATによりハブからLANで取ってます。
ただ、これだとLANを引っこ抜いてノードを切り離すことが出来ないので失敗したかなって思ってます。
LAN引っこ抜いてノードネットワーク障害ごっこしたいのに、電源も落ちちゃう。
cf. PoE (Power Over Ethernet)。
また、ケースでもPoE HATで失敗しました。
PoE HATを付けると高さが高くなります。(値段も)
買ったケースのファンとPoE HATのIsolation Transformerがぶつかります。
なので、ケース付属スペーサーだけでは足りないのでスペーサーを買い足しました。
(そして、そのスペーサーが付属スペーサーのネジ径と合わない…。付属のはM2だったっぽい…。)
付属スペーサーは高さ20mm。このケース(+ファン) + PoE HAT の場合、30mmでぴったり合います。
Amazonで激安のPoE HATはさらに高くなるので、ご注意を。
k8s cluster 構築 0. 別PCでの準備 無線ルーターを中継機として既存LANに参加させます。 Raspberry Pi Imagerを使ってmicroSDカード4枚にRaspberry Pi OS(64-bit) Liteを書き込みます。 Imagerでホスト名やssh有効化、user/passwd設定等出来るのでここでやっても可。 中継機が192....</p></div><footer class=entry-footer><span title='2023-08-07 00:00:00 +0000 UTC'>8月 7, 2023</span>&nbsp;·&nbsp;5 分</footer><a class=entry-link aria-label="post link to Raspberry Pi 4 Model B でKubernetes cluster構築した" href=https://lunarxlark.github.io/articles/20230807_raspi_k8s_cluster/></a></article><article class=post-entry><header class=entry-header><h2>hashicorp-forge/hermes</h2></header><div class=entry-content><p>hashicorp-forge/hermes 触ってみた 2023/02/01 の朝、面白いツイートが目に飛び込みました。
Excited to see the HashiCorp document management system become open source! Built on top of Google Workspaces, this has really helped our writing system scale better with the company instead of pure Drive + Groups. https://t.co/7SUrogij0k pic.twitter.com/v8lkbgjL08
— Mitchell Hashimoto (@mitchellh) January 31, 2023 ここ半年、いや 1 年位、いやもっとだったかも。設計工程の進め方にずっと不満がありました。
クラウドストレージに散らばっている 見たか見てないのかわからない、コメントへの反応 バージョン管理されていない そんな不満、いや設計構成に一石投じているように感じました。まるで初めて Packer や golps(現 gopls) に出会ったような時の衝撃が走りました。
私はブランクがあるものの、新卒から現在まで IT 業界にいて、設計書を印刷してマーカーを引いたり、ソースコード管理の自前ソフトを使用したライブラリ管理(通称リブ管)をしていた頃もあります。
それに比べたら、今では信じられないくらい進化しています。CVS や CSV ホスティングサービス、Google Sheet には編集履歴や版を設定出来たり。
そんな私にはまさに夢のツールになり得るプロダクトに見えました。ということで、早速動かしました。...</p></div><footer class=entry-footer><span title='2023-02-10 00:00:00 +0000 UTC'>2月 10, 2023</span>&nbsp;·&nbsp;1 分</footer><a class=entry-link aria-label="post link to hashicorp-forge/hermes" href=https://lunarxlark.github.io/articles/20230211_hermes/></a></article><article class=post-entry><header class=entry-header><h2>Neovim + DAP + Go</h2></header><div class=entry-content><p>TL;DR DAP(Debug Adapter Protocol)の力を借りれば、Neovim上でも視覚的にGoのデバッグが出来ました。 ここでは下記については話しません。
DAPの詳細 packer.nvimでのインストール方法 vscode-goのdebugAdapter.jsの使用方法 Neovimでデバッグするモチベーション v0.2.2から色々変わったNeovimを久々に触ってみようかと思いinit.luaへ以降して遊んでいました。 起動が早いだけでなく、LSP系の動作もサクサク動いてここ2ヶ月程快適に過ごしています。
ただ、VSCodeでのデバッグ機能がとても便利なため、デバッガ使用時のみこの快適な環境を離れていました。
どうにかNeovim上で完結させられないか…。
DAP DAPの説明はリンク先や他HPをご参照ください。
イメージを持ってもらうためLSPを引き合いに出すと、LSPがテキスト編集時に定義や変更内容や補完候補等を返すのに対して、DAPはデバッガとやりとりしてデバッグ情報を返す位のイメージを持ってもらえれば大丈夫だと思います。
Neovim + DAP + Go 使うプラグインは下記になります。
mfussenegger/nvim-dap : NeovimのDAPクライアント。VSCodeのlaunch.jsonも使用可 rcarriga/nvim-dap-ui : nvim-dapを視覚的に操作しやすいUI leoluz/nvim-dap-go : DAPのGo用設定(delve dap起動) nvim-treesitter/nvim-treesitter nvim-dap-goでテストをデバッグする際、近くのテストを見つけるのに必要 packer.nvimの設定 VSCodeのlaunch.jsonを使用しない場合、require('dap.ext.vscode').load_launchjs()は不要です。 launch.jsonを読み込めた場合、デバッグ方法の選択時にlaunch.jsonの内容が追加表示されて選択可能になります。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 -- dap plugin installation with packer.nvim ... -- dap use { "rcarriga/nvim-dap-ui", requires = { "mfussenegger/nvim-dap", "leoluz/nvim-dap-go", "nvim-treesitter/nvim-treesitter" }, config = function () vim....</p></div><footer class=entry-footer><span title='2021-11-24 00:00:00 +0000 UTC'>11月 24, 2021</span>&nbsp;·&nbsp;3 分</footer><a class=entry-link aria-label="post link to Neovim + DAP + Go" href=https://lunarxlark.github.io/articles/20211124_nvim-dap-go/></a></article><article class=post-entry><header class=entry-header><h2>gin + gorm v2でのセッションやトランザクション</h2></header><div class=entry-content><p>TL;DR ginでの各リクエストを1セッションで管理しつつ、トランザクションも管理したい。
ginのmiddlewareで、gin.Contextにgorm.WithContextを用いてGormのセッションを持たせる。 ginの各HandlerFuncの中では、gin.Context内のGormセッションからDBへアクセスする。 モチベーション Gormはv2になり色々と変わった。 Gorm 2.0 Release Note
色々な記事が書かれているがTransactoinに関してあまり書かれていない。
下記疑問を払拭して正しい使い方を自分なりに確かめたかったので試した。
なんとなく動くがこれで正しいのか? ドキュメントを読んでいてSkipDefaultTransaction:trueだと30%もパフォーマンスが上がるというがその設定はtrueにしていいいのか? っていうか、DefaultTransactionって何？ロールバックの単位とかどうやって指定するの? 確認&検証 検証時に作成したソースはgithub.com/lunarxlark/gorm2-tx
Context Gorm 2.0 #Context
GormはContextサポートを提供し、それを使いたかったらWithContext使ってくれ。 また、Sessionには単セッションモードと継続セッションモードがある。 普通は、継続セッションモードを使って、複数オペレーションをまとめるよ。 …GormのSessionってどんなことできるの?
Session Gorm 2.0 #Session
Gormは`Session`メソッドをを通して、新しいセッションを提供するよ。 新しいセッションを作る場合、設定がたくさんあるよ。DryRunやLoggerとかね。 …新しいセッションを一々作るのは望んでない。
Contextサポートしてくれるってことなのでgin.Contextへ埋め込む時にセッションを作成してそれを使い回したい。
gorm.WithContextのreturnはdb.Sessionとなっている(下記はgormのソースから抜粋)ので、gin.Contextへ埋め込むだけで新たにセッションを作る必要はない。
1 2 3 4 // WithContext change current instance db's context to ctx func (db *DB) WithContext(ctx context.Context) *DB { return db.Session(&amp;Session{Context: ctx}) } ここまでで下記みたいな感じになる。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 func main() { //....</p></div><footer class=entry-footer><span title='2021-09-12 00:00:00 +0000 UTC'>9月 12, 2021</span>&nbsp;·&nbsp;2 分</footer><a class=entry-link aria-label="post link to gin + gorm v2でのセッションやトランザクション" href=https://lunarxlark.github.io/articles/20210912_gin_gormv2/></a></article><article class=post-entry><header class=entry-header><h2>ISUCON11予選に参加して惨敗した</h2></header><div class=entry-content><p>結果 ISUCON 経験者の 2 名(@Aki_Mineo, @annkara)に誘われてチーム:コバミネとして参加しました。 私は主にインフラ担当でしたが、業務でバックエンドを Go で書いているためインフラの作業を終え次第、合流する作戦でした。
結果は 151 位 29614 点 でした。
悔しい。あそこで気付いていれば…みたいなポイントがクリティカルでした。
反省点 直すところはたくさんあったと思いますが、直すと決断するまでに迷いがありました。
時間内でのアプリケーションへの理解が足りなかった。 ユーザストーリの理解と加点の仕組みが結びつかなかった。 アプリケーションのどこを直したらいいか。 どう直したら加点されるのか。 非効率なポイントがあっても、他の要因ですぐに直せなそうだった。 見つけた時には時間が足りなかった。 修正して試す環境が本番環境のみだった。 大幅な修正をして、他メンバーとコンフリクトが起きるのが怖かった。 ざっくりタイムライン 前準備
private な作業リポジトリ(メンバーを招待) Discord との webhook deploy.sh 各種 tool のインストールスクリプト 10:00
競技スタート。 @annkaraが AWS アカウントを準備してくれたので CFn でスタック作成。 CFn でのインフラ作成完了。 ssh config 配布。全員が接続確認完了。 初回ベンチ回す。ベンチ:2981点 ソースや設定を GitHub へ。 conditionLimit : 20 -> 40。ベンチ:1704点(すぐ Revert) alp, netdata, pt-query-digest をインストール。 11:00
AP の負荷があまりにも高く、CPU100%に張り付いていたので DB を No.3 へ逃がす。ベンチ:8267点 POST /api/condition を bulk insert へ。ベンチ:9452点 nginx のログ出力を ltsv へ。 mariaDB のスロークエリを出力。 DB table isu_conditionのjia_isu_uuidへ INDEX 追加。ベンチ:22746点 DB table isuのjia_isu_uuidへ INDEX 追加。ベンチ:22492点 12:00...</p></div><footer class=entry-footer><span title='2021-08-22 00:00:00 +0000 UTC'>8月 22, 2021</span>&nbsp;·&nbsp;1 分</footer><a class=entry-link aria-label="post link to ISUCON11予選に参加して惨敗した" href=https://lunarxlark.github.io/articles/20181209_isucon11-qualify/></a></article><article class=post-entry><header class=entry-header><h2>EC2へssh with GitHubに登録している公開鍵</h2></header><div class=entry-content><p>isuconの練習時にGitHubに登録している公開鍵でEC2へssh出来るように、userdataを設定したかった。
sedでのエスケープの仕方でハマったのでメモ。
#!/bin/bash su isucon -c 'mkdir -p /home/isucon/.ssh && touch /home/isucon/.ssh/authorized_keys' su isucon -c "curl https://api.github.com/users/{{github_user_id}}/keys | grep \"key\" | sed -e 's/ \"key\": \"//g' -e 's/\"//g' >> /home/isucon/.ssh/authorized_keys"</p></div><footer class=entry-footer><span title='2021-07-04 00:00:00 +0000 UTC'>7月 4, 2021</span>&nbsp;·&nbsp;1 分</footer><a class=entry-link aria-label="post link to EC2へssh with GitHubに登録している公開鍵" href=https://lunarxlark.github.io/articles/20210704_ssh-with-publickey-without-pem/></a></article><article class=post-entry><header class=entry-header><h2>2021年版 vim + goplsの設定</h2></header><div class=entry-content><p>goplsが出てから, vimでも定義ジャンプやシンボル検索、ドキュメント参照等が行えるようになった。
たまにVSCodeを触りvimでの作業を改善できないか考える中で、自身の設定が古いことに気付いた。また、ググってもなかなか出てこなかったのでメモとして記述する。
cf. GitHub dotfiles
いきなりだが、vimrcとvim-lsp-settings/settings.jsonを抜粋して貼り付ける。
以前、GoではLspCodeAction, LspCodeLens等をサポートしていなかったが、今では使えるようになっている。
キーマップに設定している関数は全てGoで使用出来る。
ただし、カーソルがどこにいても実行出来るわけではないので注意が必要。
LspCodeActionはカーソルの位置によって実行内容が変わるのでそこも注意。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 ... Plug 'prabirshrestha/vim-lsp' Plug 'mattn/vim-lsp-settings' Plug 'prabirshrestha/asyncomplete-lsp.vim' Plug 'mattn/vim-gomod' ... " ------------------------------------------------------------------------------ " vim-lsp " ------------------------------------------------------------------------------ function! s:on_lsp_buffer_enabled() abort setlocal omnifunc=lsp#complete setlocal signcolumn=yes if exists('+tagfunc') | setlocal tagfunc=lsp#tagfunc | endif nmap &lt;buffer> &lt;leader>ac &lt;plug>(lsp-code-action) nmap &lt;buffer> &lt;leader>cl &lt;plug>(lsp-code-lens) nmap &lt;buffer> &lt;leader>df &lt;plug>(lsp-definition) nmap &lt;buffer> &lt;leader>dd &lt;plug>(lsp-document-diagnostics) nmap &lt;buffer> &lt;leader>im &lt;plug>(lsp-implementation) nmap &lt;buffer> &lt;leader>pdf &lt;plug>(lsp-peek-definition) nmap &lt;buffer> &lt;leader>sm &lt;plug>(lsp-document-symbol-search) nmap &lt;buffer> &lt;leader>Sm &lt;plug>(lsp-workspace-symbol-search) nmap &lt;buffer> &lt;leader>rf &lt;plug>(lsp-references) nmap &lt;buffer> &lt;leader>td &lt;plug>(lsp-type-definition) nmap &lt;buffer> &lt;leader>rn &lt;plug>(lsp-rename) nmap &lt;buffer> &lt;leader>en &lt;plug>(lsp-next-error) nmap &lt;buffer> &lt;leader>ep &lt;plug>(lsp-previous-error) nmap &lt;buffer> &lt;leader>ho &lt;plug>(lsp-hover) let g:lsp_format_sync_timeout = 500 autocmd!...</p></div><footer class=entry-footer><span title='2021-06-16 00:00:00 +0000 UTC'>6月 16, 2021</span>&nbsp;·&nbsp;2 分</footer><a class=entry-link aria-label="post link to 2021年版 vim + goplsの設定" href=https://lunarxlark.github.io/articles/20210616_2021vim_gopls/></a></article><article class=post-entry><header class=entry-header><h2>load test with dynamic payload by tsenart/vegeta</h2></header><div class=entry-content><p>負荷テストツールvegetaのコマンドでの使い方ぐはググるとたくさん出てくるが、ライブラリとして仕様している記事が少なく手こずったのでメモ代わりに記事にする。
やりたいこと リクエスト毎にRequestの内容を動的に変えて、負荷をかけたかった。
Headerに持つタイムスタンプがリクエスト時のタイムスタンプになるように。 userIdはuniqueになるように。(同じユーザだと重複リクエストを弾く処理があったため。) 具体的には下記のような感じでリクエストを送りたい。
1 2 3 4 5 {"header": {"timestamp":"1234"}, "body": {"userId": "lunar-1"}} {"header": {"timestamp":"1234"}, "body": {"userId": "lunar-2"}} {"header": {"timestamp":"1235"}, "body": {"userId": "lunar-3"}} ... {"header": {"timestamp":"1240"}, "body": {"userId": "lunar-n"}} vegeta.Targeterは func(*vegeta.Target) error である。
また、vegeta.Attackは、vegeta.Targeterをgoroutineで都度呼び出して、Targeter内からTargetに基づきリクエストしていることから、都度Targetが変わるようなTargeterを返す関数を作成し、それをAttack時に呼び出せば良さそう。
ってことが、 [QUESTION] Sending requests with dynamic body #330に書いてあって何度も行き来した結果やっと理解できた…。
上記を拝借して以下のようにすることで目的を達成できた。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 type yourRequestBody struct { UserID string } targeter := func(id uint64) vegeta....</p></div><footer class=entry-footer><span title='2021-03-11 00:00:00 +0000 UTC'>3月 11, 2021</span>&nbsp;·&nbsp;1 分</footer><a class=entry-link aria-label="post link to load test with dynamic payload by tsenart/vegeta" href=https://lunarxlark.github.io/articles/20210311_vegeta-dynamic-payload/></a></article><article class=post-entry><header class=entry-header><h2>2020年 ふりかえり</h2></header><div class=entry-content><p>2020年の振り返りと来年にやりたいことをつらつらと書こうと思う。 きっかけは、1on1をしてくれたEMからのアドバイスだ。
年末になると、1年を振り返るが過小評価しがち 何回かに分けてやると良い 謙遜せずやったことはやったと自分に言う そんな趣旨のアドバイスを貰った。実際、いつも自分でやる振り返りでは、今年も結局…みたいな評価になってしまっている。 仕事を頑張っていないわけではない。今年は自分でも頑張ったと思う。そんな、いつもは謙虚な(?)な自分に今年は前向きな評価をしてあげよう。 そう思った。
Dependency Injectionの実装方法を理解した トランザクションマネージャ(DB参照先を捕捉し、rollbackを埋め込んであるmethodを持つinterface)を依存性に注入することでrollback記載不要に。 トップダウンで記述するDIでは、DB参照先もあらかじめ記述しておけるが、トランザクション範囲については自身で記載しなければ出来ないという結論に。 ポインタレシーバにはポインタが、値レシーバには値がコピーされる。 メソッドをinterfaceに指定する際、レシーバにコピーされる値への変更を保持したいか等でポインタ/値レシーバどちらにするかの判断基準になる。 WebFramework Echoのmiddlewareの作り方。 Skipperによるecho.Contextの使い回し方。(structメンバーに、echo.Contextを引数に持つ関数を持たせる) Echoのデフォルトログでは、ヘッダーx-request-idに指定した値がrequest idに出る。 Echoのmiddlewareに対する理解が深まった。(雑) CloudFrontの各項目に対する理解が深まり、通信障害時にどのように調べて、どのメトリクスを見れば良いかがある程度わかるようになった。 CloudFrontのrequest idをoriginのEchoへ出力したい場合、x-amz-cf-idをEchoロガーで出力すればよい。 L@Eの使い方と開発/リリース時の注意点について教訓を得た。 L@Eへの反映には時間がかかるので、テストの仕方を工夫しなければいけない。 L@Eに適用するLambdaのversionはLATESTを指定出来ないので、リリース時にはLambdaのversionを数値指定しなければいけない。 L@Eを修正するにあたり、Node.js v10.xを少し勉強した。(動的型付け言語は好きになれない。結局、undefinedと向き合わなければならず、動的型付けのメリットが感じられなかった。) その点、TypeScriptはちょっと触った感じ楽しかった。トランスパイルという言葉を知った。(言語のversionがどんどん上がっていくECMAScriptに対して、トランスパイルが追従していけるのかちょっと不安を感じた。) AWS StepFunctionは、Lambdaをjsonというインタフェースで繋げていて、Lambdaのフローをjsonで定義しているだけなんだと理解した。 AWS Lambdaをローカルである程度動作確認出来るようにDEBUGフラグを付けた。 Go言語の開発環境が自分の中で固まってきた。(Vimで必要なPluginがある程度固定されてきた) Alfredにより、unixtimestamp変換とbase64エンコード/デコードが素早く行えるようになった。 CI/CD時にdocker pull rate limitによるエラーを、DockerHubへのログインで解消させた。 コネクションプールの生存時間が短すぎることを見つけ、DBstatsからコネクションスパイクに対してプール生存時間を伸ばすことでDBへの負荷とコネクション接続時のlatencyを短くした。</p></div><footer class=entry-footer><span title='2020-12-29 00:00:00 +0000 UTC'>12月 29, 2020</span>&nbsp;·&nbsp;1 分</footer><a class=entry-link aria-label="post link to 2020年 ふりかえり" href=https://lunarxlark.github.io/articles/20201229_2020-summary/></a></article><article class=post-entry><header class=entry-header><h2>Custome Logger using LoggerWithConfig in Echo</h2></header><div class=entry-content><p>WebFramework EchoのLoggerを弄っていて気付いた点があったのでメモ。
sample code
箇条書き responseログにHeader X-Any-Headerを出力したい場合、ログフォーマットに"any_header":${header:x-any-header}を指定すればいいよ responseログにQueryParamerter ?anyparam=xxxを出力したい場合、ログフォーマットに"any_query":${query:anyparam}を指定すればいいよ デフォルトで出力されるカラム’id’はHeader X-Request-Id を指定すると出力されるよ Skipperを設定することで、path毎にログ出力する/しない等を設定出来るよ 1, 2, 3はEchoのそういう機能だってことで特にありません。 4は結構便利だなと思いました。以下のサンプルコードでは、/healthcheckに来た場合とCI/CD等での自動テスト時にはresponseログを出力しないようにする設定例です。
sample 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 // Middleware e....</p></div><footer class=entry-footer><span title='2020-11-10 02:51:09 +0900 +0900'>11月 10, 2020</span>&nbsp;·&nbsp;2 分</footer><a class=entry-link aria-label="post link to Custome Logger using LoggerWithConfig in Echo" href=https://lunarxlark.github.io/articles/20201110_echo-custom-logger/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://lunarxlark.github.io/page/2/>次へ&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2023 <a href=https://lunarxlark.github.io/>/home/lunarxlark/.config/blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>