<!doctype html><html><head><meta name=generator content="Hugo 0.78.1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>/home/lunarxlark/.config/blog | Home</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:description" content><meta name=twitter:description content><meta name=description content><meta name=description content><meta property="og:title" content="/home/lunarxlark/.config/blog | /home/lunarxlark/.config/blog"><meta name=twitter:title content="/home/lunarxlark/.config/blog | /home/lunarxlark/.config/blog"><meta property="og:image" content><meta itemprop=name content="/home/lunarxlark/.config/blog | /home/lunarxlark/.config/blog"><meta name=application-name content="/home/lunarxlark/.config/blog | /home/lunarxlark/.config/blog"><meta property="og:site_name" content><link rel=alternate type=application/rss+xml href=https://lunarxlark.github.io/index.xml title=/home/lunarxlark/.config/blog><script async src="https://www.googletagmanager.com/gtag/js?id=G-HC9218ZECN"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-HC9218ZECN');</script><meta property="og:title" content="/home/lunarxlark/.config/blog"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://lunarxlark.github.io/"><meta property="og:updated_time" content="2021-08-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="/home/lunarxlark/.config/blog"><meta name=twitter:description content><script src=https://lunarxlark.github.io/js/feather.min.js></script><link href=https://lunarxlark.github.io/css/fonts.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://lunarxlark.github.io/css/main.css><link rel=stylesheet type=text/css href=https://lunarxlark.github.io/css/dark.css></head><body><div class=content><header><div class=main><a href=https://lunarxlark.github.io/>/home/lunarxlark/.config/blog</a></div><nav><a href=/>Home</a>
<a href=/about>About</a>
<a href=/articles>Articles</a>
<a href=/tags>Tags</a></nav></header><main class=list><div class=site-description></div><section class=list-item><h1 class=title><a href=/articles/articles/isucon11-qualify/>ISUCON11予選に参加して惨敗した</a></h1><time>Aug 22, 2021</time><br><div class=description>結果 ISUCON 経験者の 2 名(@Aki_Mineo, @annkara)に誘われてチーム:コバミネとして参加しました。 私は主にインフラ担当でしたが、業務でバックエンドを Go で書いているためインフラの作業を終え次第、合流する作戦でした。
結果は 151 位 29614 点 でした。
悔しい。あそこで気付いていれば&mldr;みたいなポイントがクリティカルでした。
反省点 直すところはたくさんあったと思いますが、直すと決断するまでに迷いがありました。
時間内でのアプリケーションへの理解が足りなかった。 ユーザストーリの理解と加点の仕組みが結びつかなかった。 アプリケーションのどこを直したらいいか。 どう直したら加点されるのか。 非効率なポイントがあっても、他の要因ですぐに直せなそうだった。 見つけた時には時間が足りなかった。 修正して試す環境が本番環境のみだった。 大幅な修正をして、他メンバーとコンフリクトが起きるのが怖かった。 ざっくりタイムライン 前準備
private な作業リポジトリ(メンバーを招待) Discord との webhook deploy.sh 各種 tool のインストールスクリプト 10:00
競技スタート。 @annkaraが AWS アカウントを準備してくれたので CFn でスタック作成。 CFn でのインフラ作成完了。 ssh config 配布。全員が接続確認完了。 初回ベンチ回す。ベンチ:2981点 ソースや設定を GitHub へ。 conditionLimit : 20 -> 40。ベンチ:1704点(すぐ Revert) alp, netdata, pt-query-digest をインストール。 11:00&mldr;</div><a href=/articles/articles/isucon11-qualify/>Read more ⟶</a></section><section class=list-item><h1 class=title><a href=/articles/articles/ssh-with-publickey-without-pem/>EC2へssh with GitHubに登録している公開鍵</a></h1><time>Jul 4, 2021</time><br><div class=description>isuconの練習時にGitHubに登録している公開鍵でEC2へssh出来るように、userdataを設定したかった。
sedでのエスケープの仕方でハマったのでメモ。
#!/bin/bash su isucon -c 'mkdir -p /home/isucon/.ssh && touch /home/isucon/.ssh/authorized_keys' su isucon -c "curl https://api.github.com/users/{{github_user_id}}/keys | grep \"key\" | sed -e 's/ \"key\": \"//g' -e 's/\"//g' >> /home/isucon/.ssh/authorized_keys" &mldr;</div><a href=/articles/articles/ssh-with-publickey-without-pem/>Read more ⟶</a></section><section class=list-item><h1 class=title><a href=/articles/articles/2021_vim_gopls/>2021年版 vim + goplsの設定</a></h1><time>Jun 16, 2021</time><br><div class=description>goplsが出てから, vimでも定義ジャンプやシンボル検索、ドキュメント参照等が行えるようになった。
たまにVSCodeを触りvimでの作業を改善できないか考える中で、自身の設定が古いことに気付いた。また、ググってもなかなか出てこなかったのでメモとして記述する。
cf. GitHub dotfiles
いきなりだが、vimrcとvim-lsp-settings/settings.jsonを抜粋して貼り付ける。
以前、GoではLspCodeAction, LspCodeLens等をサポートしていなかったが、今では使えるようになっている。
キーマップに設定している関数は全てGoで使用出来る。
ただし、カーソルがどこにいても実行出来るわけではないので注意が必要。
LspCodeActionはカーソルの位置によって実行内容が変わるのでそこも注意。
...Plug 'prabirshrestha/vim-lsp'Plug 'mattn/vim-lsp-settings'Plug 'prabirshrestha/asyncomplete-lsp.vim'Plug 'mattn/vim-gomod'..." ------------------------------------------------------------------------------" vim-lsp" ------------------------------------------------------------------------------function! s:on_lsp_buffer_enabled() abort setlocal omnifunc=lsp#complete setlocal signcolumn=yes if exists('+tagfunc') | setlocal tagfunc=lsp#tagfunc | endif nmap &lt;buffer> &lt;leader>ac &lt;plug>(lsp-code-action) nmap &lt;buffer> &lt;leader>cl &lt;plug>(lsp-code-lens) nmap &lt;buffer> &lt;leader>df &lt;plug>(lsp-definition) nmap &lt;buffer> &lt;leader>dd &lt;plug>(lsp-document-diagnostics) nmap &lt;buffer> &lt;leader>im &lt;plug>(lsp-implementation) nmap &lt;buffer> &lt;leader>pdf &lt;plug>(lsp-peek-definition) nmap &lt;buffer> &lt;leader>sm &lt;plug>(lsp-document-symbol-search) nmap &lt;buffer> &lt;leader>Sm &lt;plug>(lsp-workspace-symbol-search) nmap &lt;buffer> &lt;leader>rf &lt;plug>(lsp-references) nmap &lt;buffer> &lt;leader>td &lt;plug>(lsp-type-definition) nmap &lt;buffer> &lt;leader>rn &lt;plug>(lsp-rename) nmap &lt;buffer> &lt;leader>en &lt;plug>(lsp-next-error) nmap &lt;buffer> &lt;leader>ep &lt;plug>(lsp-previous-error) nmap &lt;buffer> &lt;leader>ho &lt;plug>(lsp-hover) let g:lsp_format_sync_timeout = 500 autocmd!&mldr;</div><a href=/articles/articles/2021_vim_gopls/>Read more ⟶</a></section><section class=list-item><h1 class=title><a href=/articles/articles/vegeta-dynamic-payload/>load test with dynamic payload by tsenart/vegeta</a></h1><time>Mar 11, 2021</time><br><div class=description>負荷テストツールvegetaのコマンドでの使い方ぐはググるとたくさん出てくるが、ライブラリとして仕様している記事が少なく手こずったのでメモ代わりに記事にする。
やりたいこと リクエスト毎にRequestの内容を動的に変えて、負荷をかけたかった。
Headerに持つタイムスタンプがリクエスト時のタイムスタンプになるように。 userIdはuniqueになるように。(同じユーザだと重複リクエストを弾く処理があったため。) 具体的には下記のような感じでリクエストを送りたい。
{"header": {"timestamp":"1234"}, "body": {"userId": "lunar-1"}} {"header": {"timestamp":"1234"}, "body": {"userId": "lunar-2"}} {"header": {"timestamp":"1235"}, "body": {"userId": "lunar-3"}} ... {"header": {"timestamp":"1240"}, "body": {"userId": "lunar-n"}} vegeta.Targeterは func(*vegeta.Target) error である。
また、vegeta.Attackは、vegeta.Targeterをgoroutineで都度呼び出して、Targeter内からTargetに基づきリクエストしていることから、都度Targetが変わるようなTargeterを返す関数を作成し、それをAttack時に呼び出せば良さそう。
ってことが、 [QUESTION] Sending requests with dynamic body #330に書いてあって何度も行き来した結果やっと理解できた&mldr;。
上記を拝借して以下のようにすることで目的を達成できた。
type yourRequestBody struct { UserID string } targeter := func(id uint64) vegeta.Targeter { return func(t *vegeta.Target) error { execTime := time.Now() requestTimestamp := execTime.Unix() req := &http.Request{ Method: "POST", URL: &url.&mldr;</div><a href=/articles/articles/vegeta-dynamic-payload/>Read more ⟶</a></section><section class=list-item><h1 class=title><a href=/articles/articles/2020-summary/>2020年 ふりかえり</a></h1><time>Dec 29, 2020</time><br><div class=description>2020年の振り返りと来年にやりたいことをつらつらと書こうと思う。 きっかけは、1on1をしてくれたEMからのアドバイスだ。
年末になると、1年を振り返るが過小評価しがち 何回かに分けてやると良い 謙遜せずやったことはやったと自分に言う そんな趣旨のアドバイスを貰った。実際、いつも自分でやる振り返りでは、今年も結局&mldr;みたいな評価になってしまっている。 仕事を頑張っていないわけではない。今年は自分でも頑張ったと思う。そんな、いつもは謙虚な(?)な自分に今年は前向きな評価をしてあげよう。 そう思った。
Dependency Injectionの実装方法を理解した トランザクションマネージャ(DB参照先を捕捉し、rollbackを埋め込んであるmethodを持つinterface)を依存性に注入することでrollback記載不要に。 トップダウンで記述するDIでは、DB参照先もあらかじめ記述しておけるが、トランザクション範囲については自身で記載しなければ出来ないという結論に。 ポインタレシーバにはポインタが、値レシーバには値がコピーされる。 メソッドをinterfaceに指定する際、レシーバにコピーされる値への変更を保持したいか等でポインタ/値レシーバどちらにするかの判断基準になる。 WebFramework Echoのmiddlewareの作り方。 Skipperによるecho.Contextの使い回し方。(structメンバーに、echo.Contextを引数に持つ関数を持たせる) Echoのデフォルトログでは、ヘッダーx-request-idに指定した値がrequest idに出る。 Echoのmiddlewareに対する理解が深まった。(雑) CloudFrontの各項目に対する理解が深まり、通信障害時にどのように調べて、どのメトリクスを見れば良いかがある程度わかるようになった。 CloudFrontのrequest idをoriginのEchoへ出力したい場合、x-amz-cf-idをEchoロガーで出力すればよい。 L@Eの使い方と開発/リリース時の注意点について教訓を得た。 L@Eへの反映には時間がかかるので、テストの仕方を工夫しなければいけない。 L@Eに適用するLambdaのversionはLATESTを指定出来ないので、リリース時にはLambdaのversionを数値指定しなければいけない。 L@Eを修正するにあたり、Node.js v10.xを少し勉強した。(動的型付け言語は好きになれない。結局、undefinedと向き合わなければならず、動的型付けのメリットが感じられなかった。) その点、TypeScriptはちょっと触った感じ楽しかった。トランスパイルという言葉を知った。(言語のversionがどんどん上がっていくECMAScriptに対して、トランスパイルが追従していけるのかちょっと不安を感じた。) AWS StepFunctionは、Lambdaをjsonというインタフェースで繋げていて、Lambdaのフローをjsonで定義しているだけなんだと理解した。 AWS Lambdaをローカルである程度動作確認出来るようにDEBUGフラグを付けた。 Go言語の開発環境が自分の中で固まってきた。(Vimで必要なPluginがある程度固定されてきた) Alfredにより、unixtimestamp変換とbase64エンコード/デコードが素早く行えるようになった。 CI/CD時にdocker pull rate limitによるエラーを、DockerHubへのログインで解消させた。 コネクションプールの生存時間が短すぎることを見つけ、DBstatsからコネクションスパイクに対してプール生存時間を伸ばすことでDBへの負荷とコネクション接続時のlatencyを短くした。 &mldr;</div><a href=/articles/articles/2020-summary/>Read more ⟶</a></section><ul class=pagination><span class="page-item page-prev"></span><span class="page-item page-next"><a href=/page/2/ class=page-link aria-label=Next><span aria-hidden=true>Next →</span></a></span></ul></main><footer><hr><a class=soc href=https://github.com/lunarxlark/ title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/lunarxlark/ title=Twitter><i data-feather=twitter></i></a>|<a class=soc href=https://instagram.com/lunarxlark/ title=Instagram><i data-feather=instagram></i></a>|⚡️
2021 © lunarxlark | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-HC9218ZECN','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script>feather.replace()</script></div></body></html>